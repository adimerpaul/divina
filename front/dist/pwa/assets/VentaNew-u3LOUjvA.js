import{_ as P,c as U,o as p,w as n,a as i,b as t,Q as v,e as f,f as h,aq as b,a5 as m,a6 as x,a7 as _,t as l,a1 as q,d as C,Z as V,at as w,h as B}from"./index-DQChmr6p.js";import{Q as D}from"./QPagination-CxQD7Ddn.js";import{Q as y}from"./QImg-DOY6ALTi.js";import{Q as k}from"./QSpace-CizLRtMD.js";import{Q as S}from"./QMarkupTable-D64y_U9g.js";import{Q}from"./QForm-BVcm-P0w.js";import{Q as N}from"./QSelect-Dhk9RMMV.js";import{Q as R}from"./QPage-rg7CFRjY.js";import{I as E}from"./Imprimir-e5_Ag4nd.js";import"./format-BvkBI9bc.js";import"./QChip-Bvabq3rY.js";import"./QMenu-IhoyNysE.js";import"./_commonjsHelpers-Bx2EM-6T.js";import"./moment-C5S46NFB.js";const F={name:"VentasNew",props:{},emits:["pacienteGet"],data(){return{loading:!1,paciente:{},ventaDialog:!1,efectivo:"",venta:{nit:"0",nombre:"SN"},pagination:{page:1,rowsPerPage:24,rowsNumber:0},receta_id:null,recognition:null,activeField:null,productos:[],productosSearch:"",productosVentas:[],unidades:["","capsulas","comprimidos","pastillas","ml","mg","otro"],vias:["","oral","intramuscular","intravenosa","subcutánea","tópica","oftálmica","ótica","nasal","rectal","vaginal"],frecuencias:["","cada 8 horas","cada 12 horas","cada 24 horas","cada 48 horas","cada 72 horas","cada 96 horas","cada 120 horas","cada 144 horas","cada 168 horas"],duraciones:["","3 dias","5 dias","7 dias","10 dias","14 dias","21 dias","28 dias","30 dias","60 dias","90 dias","120 dias","180 dias","240 dias","365 dias"]}},mounted(){if(this.$nextTick(()=>{this.$refs.inputBuscarProducto?.focus()}),this.productosGet(),"webkitSpeechRecognition"in window||"SpeechRecognition"in window){const s=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new s,this.recognition.lang="es-ES",this.recognition.interimResults=!1,this.recognition.continuous=!1,this.recognition.onresult=e=>{const r=e.results[0][0].transcript;this.activeField&&(this.venta[this.activeField]+=r)},this.recognition.onerror=e=>{console.error("Error en reconocimiento de voz:",e.error)}}else console.error("El reconocimiento de voz no está soportado en este navegador")},methods:{searchCliente(){this.loading=!0,this.$axios.post("searchCliente",{nit:this.venta.nit}).then(s=>{this.loading=!1,s.data.nombre&&(this.venta.nombre=s.data.nombre)}).catch(s=>{this.loading=!1,console.error(s)})},clickDialogVenta(){if(this.productosVentas.length===0){this.$alert.error("Debe agregar al menos un producto a la venta");return}this.ventaDialog=!0,this.venta={nit:"0",nombre:"SN",tipo_venta:"Interno",tipo_pago:"Efectivo"},this.efectivo=""},recoveryReceta(){this.$alert.dialogPrompt("Numero de receta ",{title:"Recuperar receta",cancel:!0,persistent:!0}).onOk(s=>{this.receta_id=s,this.loading=!0,this.$axios.get("receta/"+s).then(e=>{const r=e.data.receta_detalles;if(r.length===0){this.$alert.error("Receta vacía");return}this.productosVentas=r.filter(c=>c.producto_id).map(c=>({producto_id:c.producto_id,cantidad:c.cantidad,precio:c.producto.precio,producto:c.producto}))}).catch(e=>{this.$alert.error("Receta no encontrada")}).finally(()=>{this.loading=!1})})},addProducto(s){const e=this.productosVentas.find(r=>r.producto_id===s.id);if(e){e.cantidad+=1;return}this.productosVentas.push({producto_id:s.id,cantidad:1,precio:s.precio,producto:s})},productosGet(){this.loading=!0,this.$axios.get("productos",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(s=>{this.productos=s.data.data,this.pagination.rowsNumber=s.data.total,this.pagination.page=s.data.current_page,this.loading=!1,this.productos.length===1&&this.productos[0].barra===this.productosSearch&&(this.addProducto(this.productos[0]),this.productosSearch="")}).catch(s=>{this.loading=!1,console.error(s)})},submitVenta(){this.loading=!0,this.$axios.post("ventas",{ci:this.venta.nit,nombre:this.venta.nombre,productos:this.productosVentas,tipo_venta:this.venta.tipo_venta,tipo_pago:this.venta.tipo_pago,receta_id:this.receta_id}).then(s=>{this.ventaDialog=!1,this.loading=!1,this.$alert.success("Venta realizada con éxito"),this.productosVentas=[],E.nota(s.data),this.receta_id=null,this.$nextTick(()=>{this.$refs.inputBuscarProducto?.focus()}),this.productosGet()}).catch(s=>{this.loading=!1,console.error(s)})},addVenta(){this.venta={indicaciones:"",observaciones:""},this.ventaDialog=!0,this.productosVentas=[]},sendWhatsapp(s){const e=`${this.$url}/../venta/${s.id}/pdf`,r=`https://api.whatsapp.com/send?phone=${this.paciente.telefono}&text=Hola ${this.paciente.nombre}, aquí tienes tu venta: ${e}`;window.open(r,"_blank").focus()},printVenta(s){const e=`${this.$url}/../venta/${s.id}/pdf`;window.open(e,"_blank")},startRecognition(s){this.recognition?(this.activeField=s,this.recognition.start()):this.$q.notify({color:"negative",message:"El reconocimiento de voz no está soportado en este navegador"})}},computed:{cambio(){let s=this.efectivo-this.productosVentas.reduce((e,r)=>e+r.cantidad*r.precio,0);return s<0&&(s=0),s.toFixed(2)}}},I={class:"row"},T={class:"col-12 col-md-7 q-pa-xs"},$={class:"flex flex-center"},z={class:"row"},G={class:"col-6 col-md-2"},M={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},j={style:{"max-width":"190px","line-height":"0.9"}},H={style:{display:"flex","justify-content":"space-between"}},L={class:"text-bold bg-orange text-black border"},O={class:"col-12 col-md-5 q-pa-xs"},W={class:"text-right flex items-center"},Z={style:{padding:"0",margin:"0",display:"flex","align-items":"center"}},A={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":"0.9"}},J={style:{padding:"0",margin:"0"}},K=["onUpdate:modelValue"],X={style:{padding:"0",margin:"0"}},Y=["onUpdate:modelValue"],tt={class:"text-right"},et={class:"text-right text-bold"},ot={class:"row"},st={class:"col-12 col-md-3 q-pa-xs"},it={class:"col-12 col-md-3 q-pa-xs"},at={class:"col-12 col-md-3 q-pa-xs"},nt={class:"col-12 q-pa-xs"},lt={style:{padding:"0",margin:"0"}},rt={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":"0.9"}},dt={style:{padding:"0",margin:"0"}},ct={style:{padding:"0",margin:"0"}},ut={class:"text-right"},pt={class:"text-right text-bold"},ht={style:{padding:"0",margin:"0"}},mt={class:"text-right"},gt={style:{padding:"0",margin:"0"},class:"text-right"},ft={class:"col-12 q-pa-xs"};function vt(s,e,r,c,a,u){return p(),U(R,{class:"q-pa-xs"},{default:n(()=>[i(v,{flat:"",bordered:""},{default:n(()=>[i(f,{class:"row items-center q-pb-none"},{default:n(()=>[e[10]||(e[10]=t("div",{class:"text-h6"},"Ventas",-1)),i(h,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:e[0]||(e[0]=o=>s.$router.go(-1))})]),_:1}),i(f,{class:"q-pa-none"},{default:n(()=>[i(Q,{onSubmit:u.clickDialogVenta},{default:n(()=>[t("div",I,[t("div",T,[i(b,{ref:"inputBuscarProducto",modelValue:a.productosSearch,"onUpdate:modelValue":[e[1]||(e[1]=o=>a.productosSearch=o),u.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:n(()=>[i(h,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),t("div",$,[i(D,{size:"xs",modelValue:a.pagination.page,"onUpdate:modelValue":[e[2]||(e[2]=o=>a.pagination.page=o),u.productosGet],max:Math.ceil(a.pagination.rowsNumber/a.pagination.rowsPerPage),color:"primary","boundary-numbers":"","max-pages":"5"},null,8,["modelValue","max","onUpdate:modelValue"])]),t("div",z,[(p(!0),m(x,null,_(a.productos,o=>(p(),m("div",G,[i(v,{flat:"",bordered:"",class:"cursor-pointer",onClick:d=>u.addProducto(o)},{default:n(()=>[i(y,{src:`${s.$url}../images/${o.imagen}`,class:"q-mb-xs",style:{height:"120px"}},{default:n(()=>[t("div",M,[t("div",j,l(s.$filters.textUpper(o.nombre)),1),t("div",H,[t("span",null,l(o.stock),1),t("span",L,l(o.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),256))])]),t("div",O,[t("div",W,[i(k),i(h,{icon:"delete",size:"10px",color:"red",dense:"",flat:"","no-caps":"",label:"limpiar",onClick:e[3]||(e[3]=o=>{a.productosVentas=[],this.receta_id=null})})]),i(S,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:n(()=>[e[12]||(e[12]=t("thead",null,[t("tr",null,[t("th",null,"Producto"),t("th",null,"Cantidad"),t("th",null,"Precio"),t("th",null,"Subtotal")])],-1)),t("tbody",null,[(p(!0),m(x,null,_(a.productosVentas,(o,d)=>(p(),m("tr",{key:d},[t("td",Z,[i(y,{src:`${s.$url}../images/${o.producto?.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),t("div",A,[i(C,{name:"delete",color:"red",class:"cursor-pointer",onClick:g=>a.productosVentas.splice(d,1)},null,8,["onClick"]),q(" "+l(s.$filters.textUpper(o.producto?.nombre)),1)])]),t("td",J,[V(t("input",{"onUpdate:modelValue":g=>o.cantidad=g,type:"number",style:{width:"50px"}},null,8,K),[[w,o.cantidad]])]),t("td",X,[V(t("input",{"onUpdate:modelValue":g=>o.precio=g,type:"number",style:{width:"50px"},step:"0.01"},null,8,Y),[[w,o.precio]])]),t("td",tt,l(o.cantidad*o.precio)+" Bs ",1)]))),128))]),t("tfoot",null,[t("tr",null,[e[11]||(e[11]=t("td",{colspan:"3",class:"text-right"},"Total",-1)),t("td",et,l(a.productosVentas.reduce((o,d)=>o+d.cantidad*d.precio,0).toFixed(2))+" Bs",1)])])]),_:1}),i(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:a.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),i(B,{modelValue:a.ventaDialog,"onUpdate:modelValue":e[9]||(e[9]=o=>a.ventaDialog=o)},{default:n(()=>[i(v,{style:{width:"650px",margin:"0 auto"}},{default:n(()=>[i(f,{class:"q-pb-none row items-center"},{default:n(()=>[e[13]||(e[13]=t("div",{class:"text-h6"},"Nueva venta",-1)),i(k),i(h,{flat:"",round:"",dense:"",icon:"close",onClick:e[4]||(e[4]=o=>a.ventaDialog=!1)})]),_:1}),i(f,null,{default:n(()=>[i(Q,{onSubmit:u.submitVenta},{default:n(()=>[t("div",ot,[t("div",st,[i(b,{modelValue:a.venta.nit,"onUpdate:modelValue":[e[5]||(e[5]=o=>a.venta.nit=o),u.searchCliente],outlined:"",dense:"",label:"CI/NIT"},null,8,["modelValue","onUpdate:modelValue"])]),t("div",it,[i(b,{modelValue:a.venta.nombre,"onUpdate:modelValue":e[6]||(e[6]=o=>a.venta.nombre=o),outlined:"",dense:"",label:"Nombre"},null,8,["modelValue"])]),e[18]||(e[18]=t("div",{class:"col-12 col-md-3 q-pa-xs"},null,-1)),t("div",at,[i(N,{modelValue:a.venta.tipo_pago,"onUpdate:modelValue":e[7]||(e[7]=o=>a.venta.tipo_pago=o),outlined:"",dense:"",label:"Tipo de pago",options:["Efectivo","QR"]},null,8,["modelValue"])]),t("div",nt,[i(S,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:n(()=>[e[17]||(e[17]=t("thead",null,[t("tr",null,[t("th",null,"ID"),t("th",null,"Producto"),t("th",null,"Cantidad"),t("th",null,"Precio"),t("th",null,"Subtotal")])],-1)),t("tbody",null,[(p(!0),m(x,null,_(a.productosVentas,(o,d)=>(p(),m("tr",null,[t("td",null,l(o.producto_id),1),t("td",lt,[t("div",rt,l(s.$filters.textUpper(o.producto.nombre)),1)]),t("td",dt,l(o.cantidad),1),t("td",ct,l(o.precio)+" Bs ",1),t("td",ut,l(o.cantidad*o.precio)+" Bs ",1)]))),256))]),t("tfoot",null,[t("tr",null,[e[14]||(e[14]=t("td",{colspan:"3",class:"text-right text-bold"},"Total",-1)),t("td",pt,l(a.productosVentas.reduce((o,d)=>o+d.cantidad*d.precio,0).toFixed(2))+" Bs",1)]),t("tr",null,[e[15]||(e[15]=t("td",{style:{padding:"0",margin:"0"},colspan:"3",class:"text-right text-bold"},"Efectivo",-1)),t("td",ht,[t("div",mt,[V(t("input",{"onUpdate:modelValue":e[8]||(e[8]=o=>a.efectivo=o),outlined:"",dense:"",label:"Efectivo",style:{width:"100px"}},null,512),[[w,a.efectivo]])])])]),t("tr",null,[e[16]||(e[16]=t("td",{style:{padding:"0",margin:"0"},colspan:"3",class:"text-right text-bold"},"Cambio",-1)),t("td",gt,l(u.cambio),1)])])]),_:1})]),t("div",ft,[i(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:a.loading,type:"submit"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e[19]||(e[19]=t("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}const Dt=P(F,[["render",vt]]);export{Dt as default};
